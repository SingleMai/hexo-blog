<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="msvalidate.01" content="AB456E888A92CCC1848C7687BCDAA626" />


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="啊。本来是打算昨天总结这块内容的。然而，突然忘了之前是在哪个地方看到的文章，找了半天硬是没找到，奈何就放弃了。好在今天乱刷着各种技术文章，终于看到了！！那么，请看跨域！">
<meta property="og:type" content="article">
<meta property="og:title" content="前端常见跨域解决方案">
<meta property="og:url" content="SingleMai.github.io/2017/09/20/技术/js/前端常见跨域解决方案/index.html">
<meta property="og:site_name" content="嘻嘻啊的日常">
<meta property="og:description" content="啊。本来是打算昨天总结这块内容的。然而，突然忘了之前是在哪个地方看到的文章，找了半天硬是没找到，奈何就放弃了。好在今天乱刷着各种技术文章，终于看到了！！那么，请看跨域！">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-01-06T16:53:51.060Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="前端常见跨域解决方案">
<meta name="twitter:description" content="啊。本来是打算昨天总结这块内容的。然而，突然忘了之前是在哪个地方看到的文章，找了半天硬是没找到，奈何就放弃了。好在今天乱刷着各种技术文章，终于看到了！！那么，请看跨域！">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="SingleMai.github.io/2017/09/20/技术/js/前端常见跨域解决方案/"/>





<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <title> 前端常见跨域解决方案 | 嘻嘻啊的日常 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  







  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=63404910";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">嘻嘻啊的日常</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tag" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="SingleMai.github.io/2017/09/20/技术/js/前端常见跨域解决方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Singlemai">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻啊的日常">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                前端常见跨域解决方案
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-20T14:43:03+08:00">
                2017-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/09/20/技术/js/前端常见跨域解决方案/" class="leancloud_visitors" data-flag-title="前端常见跨域解决方案">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">
      
      

      
        <!-- 文章详情 -->
        undefined
        <p>啊。本来是打算昨天总结这块内容的。然而，突然忘了之前是在哪个地方看到的文章，找了半天硬是没找到，奈何就放弃了。好在今天乱刷着各种技术文章，终于看到了！！那么，请看跨域！<br><a id="more"></a></p>
<h2 id="什么是跨域？"><a href="#什么是跨域？" class="headerlink" title="什么是跨域？"></a>什么是跨域？</h2><p>跨域是指一个域下的文档或者脚本试图去请求另一个域下的资源。这里描述的是广义的跨域。</p>
<ul>
<li>资源跳转：A链接、重定向、表单提交</li>
<li>资源嵌入： <code>&lt;link&gt;、&lt;script&gt;/&lt;img&gt;/&lt;frame&gt;</code>等dom标签，以及样式中的<code>background:url()</code>等的文件外链</li>
<li>脚本请求：js发起的ajax请求、dom和js对象的跨域操作。</li>
</ul>
<p>然而，我们一般讨论的都是狭义的跨域，也就是由浏览器同源策略限制引起的一类请求场景。</p>
<h3 id="什么是同源策略"><a href="#什么是同源策略" class="headerlink" title="什么是同源策略"></a>什么是同源策略</h3><p>同源策略/SOP（same origin policy）是一种约定，是浏览器最核心也是最基本的安全功能，如果缺乏了同源策略，浏览器很容易受到XSS、CSRF（跨站请求伪造）等算计。</p>
<p>场景：<br>假设用户在访问银行网站的时候并没有登出。他又跑到了任意其他网站上，刚好这个网站上有恶意的js代码，在后台请求银行网站的信息。因为用户目前仍然是银行站点的登录状态，那么恶意代码就可以在银行站点做任何事情。</p>
<p>所以同源策略限制以下几种行为：</p>
<ol>
<li>Cookie、LocalStorage 和 IndexDB无法读取</li>
<li>DOM 和 JS对象无法获取</li>
<li>AJAX请求不能发送</li>
</ol>
<p>所谓的同源就是指“协议 + 域名 + 端口”三者要相同，即便两个不同的域名指向同一个ip地址，也非同源。具体的跨域场景看下表：</p>
<table>
<thead>
<tr>
<th>URL</th>
<th>说明</th>
<th>是否允许通信</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://www.domain.com/a.js" target="_blank" rel="external">http://www.domain.com/a.js</a><br><a href="http://www.domain.com/b.js" target="_blank" rel="external">http://www.domain.com/b.js</a><br><a href="http://www.domain.com/lab/c.js" target="_blank" rel="external">http://www.domain.com/lab/c.js</a></td>
<td>同一域名，不同文件或路径</td>
<td>允许</td>
</tr>
<tr>
<td><a href="http://www.domain.com:8000/a.js" target="_blank" rel="external">http://www.domain.com:8000/a.js</a><br><a href="http://www.domain.com/b.js" target="_blank" rel="external">http://www.domain.com/b.js</a></td>
<td>同一域名，不同端口</td>
<td>不允许</td>
</tr>
<tr>
<td><a href="http://www.domain.com/a.js" target="_blank" rel="external">http://www.domain.com/a.js</a><br><a href="https://www.domain.com/b.js" target="_blank" rel="external">https://www.domain.com/b.js</a></td>
<td>同一域名，不同协议</td>
<td>不允许</td>
</tr>
<tr>
<td><a href="http://www.domain.com/a.js" target="_blank" rel="external">http://www.domain.com/a.js</a><br><a href="http://x.domain.com/b.js" target="_blank" rel="external">http://x.domain.com/b.js</a><br><a href="http://domain.com" target="_blank" rel="external">http://domain.com</a></td>
<td>主域相同，子域不同</td>
<td>不允许</td>
</tr>
<tr>
<td><a href="http://www.domain.com/a.js" target="_blank" rel="external">http://www.domain.com/a.js</a><br><a href="http://www.domain2.com/b.js" target="_blank" rel="external">http://www.domain2.com/b.js</a><br><a href="http://domain.com" target="_blank" rel="external">http://domain.com</a></td>
<td>不同域名</td>
<td>不允许</td>
</tr>
</tbody>
</table>
<h2 id="跨域的解决方案"><a href="#跨域的解决方案" class="headerlink" title="跨域的解决方案"></a>跨域的解决方案</h2><p>然而跨域的需求却是存在的，两个互相可信的站点之间可以保持信息沟通是存在需求的。于是，想办法实现跨域吧~~</p>
<h3 id="jsonp实现跨域"><a href="#jsonp实现跨域" class="headerlink" title="jsonp实现跨域"></a>jsonp实现跨域</h3><p>有关jsonp的内容已经在之前的文章<a href="https://singlemai.github.io/2017/07/27/%E6%8A%80%E6%9C%AF/js/Ajax%E7%9A%84%E5%AE%9E%E7%8E%B0(ajax%E4%B8%8Ejsonp" target="_blank" rel="external">Ajax的实现（ajax与jsonp)</a>/)说得挺详细的了，直接跳转吧~</p>
<p>但是jsonp有一个缺点：只能实现get一种请求。</p>
<h3 id="document-domain-iframe跨域"><a href="#document-domain-iframe跨域" class="headerlink" title="document.domain + iframe跨域"></a>document.domain + iframe跨域</h3><p>此方案同样有所缺点：仅限主域相同，子域不同的跨域应用场景。<br>实现原理： 两个页面都通过js强制设置<code>document.domain</code>为基础主域，就实现了同域。</p>
<h4 id="父窗口："><a href="#父窗口：" class="headerlink" title="父窗口："></a>父窗口：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;iframe id=&quot;iframe&quot; src=&quot;http://child.domain.com/b.html&quot;&gt;&lt;/iframe&gt;</div><div class="line">&lt;script&gt;</div><div class="line">  document.domain = &apos;domain.com&apos;;</div><div class="line">  var user = &apos;admin&apos;;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<h4 id="子窗口"><a href="#子窗口" class="headerlink" title="子窗口"></a>子窗口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">  document.domain = &apos;domain.com&apos;;</div><div class="line">  alert(&apos;get js data from parent&apos; + window.parent.user);</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<h3 id="location-hash-iframe"><a href="#location-hash-iframe" class="headerlink" title="location.hash + iframe"></a>location.hash + iframe</h3><p>实现原理：A域与B域要相互通信，通过中间页c来实现。三个页面，不同域之间利用<code>iframe</code>的<code>location.hash</code>传值，相同域之间直接用js访问来通信。</p>
<p>具体实现：A域：a.html =&gt; B域：b.html =&gt; A域：c.html, a 与 b 不同于只能通过hash值单向通信，b 与 c 也不同于也只能单向通信，但是c 与 a 同域，所以c可通过parent.parent访问a页面的所有对象。</p>
<h4 id="a-html-http-www-domain1-com-a-html"><a href="#a-html-http-www-domain1-com-a-html" class="headerlink" title="a.html:(http://www.domain1.com/a.html)"></a>a.html:(<a href="http://www.domain1.com/a.html" target="_blank" rel="external">http://www.domain1.com/a.html</a>)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;iframe id=&quot;iframe&quot; src=&quot;http://www.domain2.com/b.html&quot; style=&quot;display=none;&quot;&gt;</div><div class="line">&lt;script&gt;</div><div class="line">  var iframe = document.getElementById(&apos;iframe&apos;);</div><div class="line">  // 向b.html传hash值</div><div class="line">  setTimeout(function () &#123;</div><div class="line">      iframe.src = iframe.src + &apos;#user=admin&apos;;//改变url的hash值</div><div class="line">  &#125;, 1000);</div><div class="line">  // 开放给同域c.html的回调方法</div><div class="line">  function onCallback(res) &#123;</div><div class="line">    alert(&apos;data from c.html:&apos; + res);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h4 id="b-html-http-www-domain2-com-b-html"><a href="#b-html-http-www-domain2-com-b-html" class="headerlink" title="b.html:(http://www.domain2.com/b.html)"></a>b.html:(<a href="http://www.domain2.com/b.html" target="_blank" rel="external">http://www.domain2.com/b.html</a>)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;iframe id=&quot;iframe&quot; src=&quot;http://www.domain1.com/c.html&quot; display=&quot;none;&quot;&gt;</div><div class="line">&lt;script&gt;</div><div class="line">  var iframe = document.getElementById(&apos;iframe&apos;);</div><div class="line">  window.onhasChange = function() &#123;</div><div class="line">    iframe.src =iframe.src + location.hash; //通过hash传递给c页面</div><div class="line">  &#125;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<h4 id="c-html-http-www-domain1-com-c-html"><a href="#c-html-http-www-domain1-com-c-html" class="headerlink" title="c.html:(http://www.domain1.com/c.html)"></a>c.html:(<a href="http://www.domain1.com/c.html" target="_blank" rel="external">http://www.domain1.com/c.html</a>)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">  window.onhasChange = function() &#123;</div><div class="line">    window.parent.parent.onCallback(&apos;hello:&apos; + location.hash);</div><div class="line">  &#125;;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<h3 id="window-name-iframe"><a href="#window-name-iframe" class="headerlink" title="window.name + iframe"></a>window.name + iframe</h3><p><code>window.name</code>的独特之处：name值在不同的页面（甚至不同的域名）加载后依旧存在，并且可以支持非常长的name值（2MB）；<br>实现原理：通过动态创建一个iframe，访问跨域页，在跨域成功后跳转回同域的代理页，利用name长期存在的特性便可以获取到数据传递给同域的本页</p>
<h4 id="a-html-http-www-domain1-com-a-html-1"><a href="#a-html-http-www-domain1-com-a-html-1" class="headerlink" title="a.html:(http://www.domain1.com/a.html)"></a>a.html:(<a href="http://www.domain1.com/a.html" target="_blank" rel="external">http://www.domain1.com/a.html</a>)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">var proxy = function(url, callback) &#123;</div><div class="line">  var state = 0;</div><div class="line">  var iframe = document.createElement(&apos;iframe&apos;);</div><div class="line"></div><div class="line">  // 加载跨域页</div><div class="line">  iframe.src = url;</div><div class="line"></div><div class="line">  // 这里会触发两次onoload事件，第一次是加载跨域页，第二次是加载代理页</div><div class="line">  iframe.onload = function() &#123;</div><div class="line">    if(state === 0) &#123;</div><div class="line">      // 这里触发的是加载跨域页，切换到代理页</div><div class="line">      iframe.contentWindow.location = &apos;http://www.domain1.com/proxy.html&apos;;</div><div class="line">      state = 1;</div><div class="line">    &#125; else if (state === 1) &#123;</div><div class="line">      // 这里触发的是加载代理页,读取完同域window.name后</div><div class="line">      callback(iframe.contentWindow.name);</div><div class="line">      // 销毁iframe，释放内存，保证不被其他域iframe js访问</div><div class="line">      destoryFrame();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // 销毁iframe</div><div class="line">  function destoryFrame() &#123;</div><div class="line">    iframe.contentWindow.document.write(&apos;&apos;);</div><div class="line">    iframe.contentWindow.close();</div><div class="line">    document.body.removeChild(iframe);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 请求跨域b页面数据</div><div class="line">proxy(&apos;http://www.domain2.com/b.html&apos;, function(data)&#123;</div><div class="line">    alert(data);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h4 id="proxy-html"><a href="#proxy-html" class="headerlink" title="proxy.html"></a>proxy.html</h4><p>中间代理页，与a.html同域，内容为空即可</p>
<h4 id="b-html"><a href="#b-html" class="headerlink" title="b.html"></a>b.html</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">  window.name = &apos;data data data ...&apos;;</div><div class="line">&lt;script&gt;</div></pre></td></tr></table></figure>
<p>总结： 通过iframe的src属性由外域转向本地域，跨域数据即由iframe的window.name从外域传递到本地域。这个就巧妙地绕过了浏览器的跨域访问限制，但同时它又是安全的操作。</p>
<h3 id="postMessage跨域"><a href="#postMessage跨域" class="headerlink" title="postMessage跨域"></a>postMessage跨域</h3><p>postMessage是HTML5 XMLHttpRequest Level 2中的API，且是为数不多可以跨域操作的window属性之一，它可用于解决以下方面的问题：</p>
<ol>
<li>页面和其打开的新窗口的数据传递(属于两个tab页之间的通信)</li>
<li>多窗口之间消息传递</li>
<li>页面与嵌套的iframe消息传递</li>
<li>上面三个场景的跨域数据传递</li>
</ol>
<p>用法：<code>postMesssage(data, origin)</code>方法接受两个参数</p>
<ul>
<li>data: html5规范支持任意基本类型或可复制的对象，但部分浏览器只支持字符串，所以传参时最好用JSON.stringify()序列化</li>
<li>origin: 协议 + 主机 + 端口号，也可以设置为<code>*</code> ，表示可以传递给任意窗口，如果要指定和当前窗口同源的话，设置为’/‘</li>
</ul>
<h4 id="a-html"><a href="#a-html" class="headerlink" title="a.html"></a>a.html</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;iframe id=&quot;iframe&quot; src=&quot;http://www.domain2.com/b.html&quot; style=&quot;display:none;&quot;&gt;</div><div class="line">&lt;script&gt;</div><div class="line">  var iframe = document.getElementById(&apos;iframe&apos;);</div><div class="line">  iframe.onload = function() &#123;</div><div class="line">    var data = &#123;</div><div class="line">      name: &apos;aym&apos;</div><div class="line">    &#125;;</div><div class="line">    // 向domain2传递跨域数据</div><div class="line">    iframe.contentWindow.postMesssage(JSON.stringify(data), &apos;http://www.domain2.com&apos;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // 接受domain2的返回数据</div><div class="line">  window.addEventListener(&apos;message&apos;, function(e) &#123;</div><div class="line">    alert(&apos;data from domain2&apos; + e.data)</div><div class="line">  &#125;, 1000)</div></pre></td></tr></table></figure>
<h4 id="b-html-1"><a href="#b-html-1" class="headerlink" title="b.html"></a>b.html</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">  window.addEventListener(&apos;message&apos;, function(e) &#123;</div><div class="line">    alert(e.data);</div><div class="line"></div><div class="line">    var data = JSON.parse(e.data);</div><div class="line">    if(data) &#123;</div><div class="line">      data.num = 16;</div><div class="line"></div><div class="line">      window.parent.postMesssage(JSON.stringify(data), &apos;http://www.domain1.com&apos;);</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&lt;/scirpt&gt;</div></pre></td></tr></table></figure>
<h3 id="跨域资源共享（CORS"><a href="#跨域资源共享（CORS" class="headerlink" title="跨域资源共享（CORS)"></a>跨域资源共享（CORS)</h3><p>普通跨域请求： 只需要服务端设置<code>Access-Control-Alloww-Origin</code>即可，前端无须设置。</p>
<p>带cookie请求： 前后端都需要设置字段，另外需注意：所带cookie为跨域请求接口所在域的cookie，而非当前页。</p>
<p>目前，所有浏览器都支持该功能(IE8+：IE8/9需要使用XDomainRequest对象来支持CORS）)，CORS也已经成为主流的跨域解决方案。</p>
<p>CORS和JSONP对比</p>
<ul>
<li>JSONP只能实现GET请求，而CORS支持所有类型的HTTP请求。</li>
<li>使用CORS，开发者可以使用普通的XMLHttpRequest发起请求和获得数据，比起JSONP有更好的错误处理。</li>
<li>JSONP主要被老的浏览器支持，它们往往不支持CORS，而绝大多数现代浏览器都已经支持了CORS）。</li>
</ul>
<p>CORS与JSONP相比，无疑更为先进、方便和可靠。</p>
<p>有关CORS的详情，可以跳转<a href="">详解CORS跨域资源共享</a></p>
<h4 id="前端设置："><a href="#前端设置：" class="headerlink" title="前端设置："></a>前端设置：</h4><ol>
<li>原生ajax<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">var xhr = new XMLHttpRequest(); //IE8 9需要使用window.XDomainRequest兼容</div><div class="line">// 前端设置是否带cookie</div><div class="line">xhr.withCredentials = true;</div><div class="line"></div><div class="line">xhr.open(&apos;post&apos;, &apos;http://www.domain2.com:8080/login&apos;, ture);</div><div class="line">xhr.setRequestHeader(&apos;Content-Type&apos;, &apos;application/x-www-form-urlencoded&apos;);</div><div class="line">xhr.send(&apos;user=admin&apos;);</div><div class="line"></div><div class="line">xhr.onreadystatechange = function() &#123;</div><div class="line">  if(xhr.readyState == 4 &amp;&amp; xhr.status == 200) &#123;</div><div class="line">    alert(xhr.responseText);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="服务端设置："><a href="#服务端设置：" class="headerlink" title="服务端设置："></a>服务端设置：</h4><p>若后端设置成功，前端浏览器控制台则不会出现跨域报错信息，反之，说明没设成功。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// 跨域后台设置</div><div class="line">res.writeHead(200, &#123;</div><div class="line">    &apos;Access-Control-Allow-Credentials&apos;: &apos;true&apos;,     // 后端允许发送Cookie</div><div class="line">    &apos;Access-Control-Allow-Origin&apos;: &apos;http://www.domain1.com&apos;,    // 允许访问的域（协议+域名+端口）</div><div class="line">    &apos;Set-Cookie&apos;: &apos;l=a123456;Path=/;Domain=www.domain2.com;HttpOnly&apos;   // HttpOnly:脚本无法读取cookie</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="nginx代理跨域-未写"><a href="#nginx代理跨域-未写" class="headerlink" title="nginx代理跨域(未写)"></a>nginx代理跨域(未写)</h3><p>这里nginx的使用。。。没学过，所以只当挖了个坑吧 因为和下面的nodejs结合vue实现差不多，所以，以后有机会接触再回来补这里的</p>
<h3 id="nodejs中间件代理跨域"><a href="#nodejs中间件代理跨域" class="headerlink" title="nodejs中间件代理跨域"></a>nodejs中间件代理跨域</h3><ol>
<li>Vue框架的跨域（1次跨域）<br>利用node + webpack + webpack-dev-server代理接口跨域。在开发环境下，由于vue渲染服务和接口代理服务都是webpack-dev-server同一个，所以页面与代理接口之间不再跨域，无须设置headers跨域信息了。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">module.exports = &#123;</div><div class="line">    entry: &#123;&#125;,</div><div class="line">    module: &#123;&#125;,</div><div class="line">    ...</div><div class="line">    devServer: &#123;</div><div class="line">        historyApiFallback: true,</div><div class="line">        proxy: [&#123;</div><div class="line">            context: &apos;/login&apos;,</div><div class="line">            target: &apos;http://www.domain2.com:8080&apos;,  // 代理跨域目标接口</div><div class="line">            changeOrigin: true,</div><div class="line">            cookieDomainRewrite: &apos;www.domain1.com&apos;  // 可以为false，表示不修改</div><div class="line">        &#125;],</div><div class="line">        noInfo: true</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>在一次慕课网的学习，提到到<code>dev-sever.js</code>进行手动设置代理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">// 手动添加接口代理 axios</div><div class="line">var apiRoutes = express.Router()</div><div class="line"></div><div class="line">apiRoutes.get(&apos;/getDiscList&apos;, function (req, res) &#123;</div><div class="line">  let url = &apos;https://c.y.qq.com/splcloud/fcgi-bin/fcg_get_diss_by_tag.fcg&apos;</div><div class="line">  axios.get(url, &#123;</div><div class="line">    headers: &#123;</div><div class="line">      referer: &apos;https://c.y.qq.com&apos;,</div><div class="line">      host: &apos;c.y.qq.com&apos;</div><div class="line">    &#125;,</div><div class="line">    params: req.query</div><div class="line">  &#125;).then((response) =&gt; &#123;</div><div class="line">    res.json(response.data)</div><div class="line">  &#125;).catch((err) =&gt; &#123;</div><div class="line">    console.log(err);</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<ol>
<li>非vue（2次跨域）<br>利用node + express + http-proxy-middleware搭建一个proxy服务器。</li>
</ol>
<h4 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">var xhr = new XMLHttpRequest();</div><div class="line"></div><div class="line">// 前端开关：浏览器是否读写cookie</div><div class="line">xhr.withCredentials = true;</div><div class="line"></div><div class="line">// 访问http-proxy-middleware代理服务器</div><div class="line">xhr.open(&apos;get&apos;, &apos;http://www.domain1.com:3000/login?user=admin&apos;, true);</div><div class="line">xhr.send();</div></pre></td></tr></table></figure>
<h4 id="代理服务器"><a href="#代理服务器" class="headerlink" title="代理服务器"></a>代理服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var proxy = require(&apos;http-proxy-middleware&apos;);</div><div class="line">var app = express();</div><div class="line"></div><div class="line">app.use(&apos;/&apos;, proxy(&#123;</div><div class="line">    // 代理跨域目标接口</div><div class="line">    target: &apos;http://www.domain2.com:8080&apos;,</div><div class="line">    changeOrigin: true,</div><div class="line"></div><div class="line">    // 修改响应头信息，实现跨域并允许带cookie</div><div class="line">    onProxyRes: function(proxyRes, req, res) &#123;</div><div class="line">        res.header(&apos;Access-Control-Allow-Origin&apos;, &apos;http://www.domain1.com&apos;);</div><div class="line">        res.header(&apos;Access-Control-Allow-Credentials&apos;, &apos;true&apos;);</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    // 修改响应信息中的cookie域名</div><div class="line">    cookieDomainRewrite: &apos;www.domain1.com&apos;  // 可以为false，表示不修改</div><div class="line">&#125;));</div><div class="line"></div><div class="line">app.listen(3000);</div><div class="line">console.log(&apos;Proxy server is listen at port 3000...&apos;);</div></pre></td></tr></table></figure>
<h3 id="WebSocket协议跨域"><a href="#WebSocket协议跨域" class="headerlink" title="WebSocket协议跨域"></a>WebSocket协议跨域</h3><p>详细可以看webSocket那一章吧~~<br>这里推荐使用Socket.io??</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/18/技术/js/细数js之for循环/" rel="next" title="细数js之for循环">
                <i class="fa fa-chevron-left"></i> 细数js之for循环
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/21/技术/js/谈一谈Web缓存/" rel="prev" title="谈一谈Web缓存">
                谈一谈Web缓存 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>


    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Singlemai" />
          <p class="site-author-name" itemprop="name">Singlemai</p>
           
              <p class="site-description motion-element" itemprop="description">记录有关嘻嘻啊的一切</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">133</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tag/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/SingleMai" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是跨域？"><span class="nav-number">1.</span> <span class="nav-text">什么是跨域？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是同源策略"><span class="nav-number">1.1.</span> <span class="nav-text">什么是同源策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#跨域的解决方案"><span class="nav-number">2.</span> <span class="nav-text">跨域的解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jsonp实现跨域"><span class="nav-number">2.1.</span> <span class="nav-text">jsonp实现跨域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#document-domain-iframe跨域"><span class="nav-number">2.2.</span> <span class="nav-text">document.domain + iframe跨域</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#父窗口："><span class="nav-number">2.2.1.</span> <span class="nav-text">父窗口：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#子窗口"><span class="nav-number">2.2.2.</span> <span class="nav-text">子窗口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#location-hash-iframe"><span class="nav-number">2.3.</span> <span class="nav-text">location.hash + iframe</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-html-http-www-domain1-com-a-html"><span class="nav-number">2.3.1.</span> <span class="nav-text">a.html:(http://www.domain1.com/a.html)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-html-http-www-domain2-com-b-html"><span class="nav-number">2.3.2.</span> <span class="nav-text">b.html:(http://www.domain2.com/b.html)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-html-http-www-domain1-com-c-html"><span class="nav-number">2.3.3.</span> <span class="nav-text">c.html:(http://www.domain1.com/c.html)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#window-name-iframe"><span class="nav-number">2.4.</span> <span class="nav-text">window.name + iframe</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-html-http-www-domain1-com-a-html-1"><span class="nav-number">2.4.1.</span> <span class="nav-text">a.html:(http://www.domain1.com/a.html)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#proxy-html"><span class="nav-number">2.4.2.</span> <span class="nav-text">proxy.html</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-html"><span class="nav-number">2.4.3.</span> <span class="nav-text">b.html</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#postMessage跨域"><span class="nav-number">2.5.</span> <span class="nav-text">postMessage跨域</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-html"><span class="nav-number">2.5.1.</span> <span class="nav-text">a.html</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-html-1"><span class="nav-number">2.5.2.</span> <span class="nav-text">b.html</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨域资源共享（CORS"><span class="nav-number">2.6.</span> <span class="nav-text">跨域资源共享（CORS)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#前端设置："><span class="nav-number">2.6.1.</span> <span class="nav-text">前端设置：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端设置："><span class="nav-number">2.6.2.</span> <span class="nav-text">服务端设置：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx代理跨域-未写"><span class="nav-number">2.7.</span> <span class="nav-text">nginx代理跨域(未写)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nodejs中间件代理跨域"><span class="nav-number">2.8.</span> <span class="nav-text">nodejs中间件代理跨域</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#前端代码"><span class="nav-number">2.8.1.</span> <span class="nav-text">前端代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代理服务器"><span class="nav-number">2.8.2.</span> <span class="nav-text">代理服务器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WebSocket协议跨域"><span class="nav-number">2.9.</span> <span class="nav-text">WebSocket协议跨域</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Singlemai</span>
</div>

<div>
  <span id="busuanzi_container_site_pv">
      本站总访问量<span id="busuanzi_value_site_pv"></span>次&nbsp;
  </span>
  <span id="busuanzi_container_site_uv">
    |&nbsp;本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("Wa5xGxBSSrAdS5D0vseHGUjp-gzGzoHsz", "LFyAsHJY8hiThrDvmh3FWxbh");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

</body>
</html>
